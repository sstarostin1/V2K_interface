# Implementation Plan

[Overview]
Реализовать упрощенную панель настроек графика с настройкой временного окна и создать систему конфигурации для окон графиков.

Панель настроек будет добавлена к каждому графику в виде всплывающего окна с анимацией, открывающегося по кнопке в заголовке графика. В панель включена только настройка временного окна (1-1440 минут) для отображения данных. Также реализована система сохранения конфигурации для каждого окна графиков, включающая положение, размер, настройки графиков, с автоматическим удалением при закрытии окна.

[Types]
Добавление новых типов данных для конфигурации окон и настроек графиков.

```python
class PlotSettings:
    time_window_minutes: int = 5

class DockWindowConfig:
    geometry: QRect
    plot_settings: Dict[str, PlotSettings]  # channel_name -> settings
    visible_channels: List[str]
    layout_orientation: Qt.Orientation
    splitter_sizes: List[int]
```

[Files]
Создание новых файлов для панели настроек и системы конфигурации, модификация существующих файлов графиков.

Новые файлы:
- vcas_viewer/plotting/plot_settings_panel.py - панель настроек графика
- vcas_viewer/core/window_config.py - система конфигурации окон

Модифицируемые файлы:
- vcas_viewer/plotting/draggable_plot_widget.py - добавление кнопки настроек и панели
- vcas_viewer/plotting/plot_dock_window.py - перенос поля времени в панель настроек, добавление сохранения конфига
- vcas_viewer/core/config.py - добавление методов для работы с конфигами окон

[Functions]
Добавление функций для управления настройками и конфигурацией.

Новые функции:
- PlotSettingsPanel.__init__(parent_plot: DraggablePlotWidget) - конструктор панели
- PlotSettingsPanel.show_panel() - показать панель с анимацией
- PlotSettingsPanel.hide_panel() - скрыть панель
- PlotSettingsPanel.apply_settings() - применить настройки к графику
- WindowConfig.save_window_config(window_id: str, config: DockWindowConfig) - сохранить конфиг окна
- WindowConfig.load_window_config(window_id: str) -> DockWindowConfig - загрузить конфиг окна
- WindowConfig.delete_window_config(window_id: str) - удалить конфиг окна

Модифицируемые функции:
- DraggablePlotWidget.setup_ui() - добавить кнопку настроек в заголовок
- DraggablePlotWidget.set_time_window(seconds: int) - применение настроек времени
- DraggablePlotWidget.set_auto_range(axis: str, enabled: bool) - установка автошкалы
- DraggablePlotWidget.set_max_points(points: int) - установка максимального количества точек
- PlotDockWindow._create_control_panel() - убрать поле времени, добавить кнопку настроек
- PlotDockWindow.closeEvent() - сохранить конфиг и удалить из памяти
- PlotDockWindow.save_config() - сохранить текущую конфигурацию
- PlotDockWindow.load_config() - загрузить конфигурацию при открытии

[Classes]
Создание новых классов для панели настроек и конфигурации.

Новые классы:
- PlotSettingsPanel(QWidget) - панель настроек с анимацией
  - Методы: setup_ui(), setup_animation(), toggle_panel(), apply_settings()
  - Атрибуты: time_spinbox
- WindowConfig - менеджер конфигурации окон
  - Методы: save_window_config(), load_window_config(), delete_window_config()
  - Атрибуты: config_dir - директория для хранения конфигов

Модифицируемые классы:
- DraggablePlotWidget - добавить атрибуты settings_panel, settings_button, plot_settings
  - Новые методы: create_settings_button(), show_settings_panel(), apply_plot_settings()
- PlotDockWindow - добавить атрибуты window_config, window_id, current_config
  - Модифицировать _create_control_panel() для удаления поля времени
  - Добавить методы save_config(), load_config()

[Dependencies]
Без изменений зависимостей.

Проект уже использует PyQt5, pyqtgraph, поэтому дополнительные зависимости не требуются.

[Testing]
Создание unit-тестов для новых компонентов и интеграционных тестов.

Новые тесты:
- test_plot_settings_panel.py - тестирование панели настроек
- test_window_config.py - тестирование системы конфигурации
- test_draggable_plot_widget_settings.py - тестирование интеграции настроек в график

Модификация существующих тестов:
- Обновить тесты PlotDockWindow для работы без поля времени в панели управления
- Добавить тесты для сохранения/загрузки конфигурации

[Implementation Order]
Последовательная реализация компонентов с интеграцией.

1. Создать PlotSettingsPanel с базовой функциональностью (время, автошкала, макс точки)
2. Добавить кнопку настроек в DraggablePlotWidget
3. Интегрировать панель в DraggablePlotWidget с сигналами
4. Создать WindowConfig для управления конфигурацией
5. Модифицировать PlotDockWindow для использования конфигурации
6. Перенести настройки времени из панели управления в панель настроек
7. Добавить сохранение/загрузку конфигурации при открытии/закрытии окон
8. Протестировать интеграцию всех компонентов
9. Добавить обработку клика вне панели для закрытия

[Bug Fixes]
Исправление выявленных багов в работе панели настроек.

1. Исправить позиционирование панели при resize окна
   - Добавить resizeEvent в DraggablePlotWidget для обновления позиции панели
   - Обновлять позицию панели при изменении размера виджета

2. Исправить eventFilter для исключения кликов на элементы панели
   - Модифицировать eventFilter в PlotSettingsPanel
   - Исключить клики на самой панели и ее дочерних элементах из обработки закрытия

3. Улучшить логику кнопки настроек (закрытие при повторном клике)
   - Использовать toggle_panel() для показа/скрытия панели
   - Панель закрывается при повторном клике на кнопку

4. Исправить смещение панели при каждом открытии/закрытии
   - Изменить позиционирование панели: привязать к правому верхнему углу графика
   - Убрать зависимость от позиции кнопки настроек
   - Использовать фиксированное положение относительно графика

5. Исправить eventFilter для корректного определения кликов внутри панели
   - Использовать проверку геометрии панели вместо проверки иерархии объектов
   - Проверять event.globalPos() и self.rect().contains() для определения клика внутри панели
   - Сохранить проверку кнопки настроек для предотвращения закрытия при клике на нее

6. Исправить ошибки импорта и обработки данных
   - Добавить импорт QPoint в plot_settings_panel.py
   - Исправить обработку None данных в _is_point_on_curve

[Implementation Report]
Подробный отчет о выполненной работе по реализации панели настроек графика.

## Выполненные задачи

### 1. Создание панели настроек графика (plot_settings_panel.py)
**Созданы классы:**
- `PlotSettings` - структура данных для хранения настроек графика
- `PlotSettingsPanel(QWidget)` - виджет панели настроек с анимацией

**Функциональность:**
- Всплывающая панель с анимацией появления/исчезновения (200мс)
- Настройка временного окна (1-1440 минут, шаг 1 мин)
- Автоматическое закрытие при клике вне панели
- Сигнальная система для уведомления об изменениях настроек

**Технические особенности:**
- Использование QPropertyAnimation для плавной анимации
- EventFilter для обработки глобальных событий мыши
- Проверка геометрии панели для определения кликов внутри/вне
- Стилизация с помощью QSS для современного вида

### 2. Интеграция с виджетом графика (draggable_plot_widget.py)
**Добавленные компоненты:**
- Кнопка настроек (⚙) в заголовке графика
- Экземпляр PlotSettingsPanel для каждого графика
- Обработчик сигналов изменения настроек

**Новые методы:**
- `show_settings_panel()` - переключение видимости панели
- `_on_settings_changed()` - обработчик изменения настроек
- `apply_plot_settings()` - применение настроек к графику

**Интеграция:**
- Панель позиционируется относительно графика (правый верхний угол)
- Автоматическое обновление позиции при resize окна
- Применение настроек в реальном времени

### 3. Система конфигурации окон (window_config.py)
**Создан класс WindowConfig:**
- Управление конфигурациями окон графиков
- Сохранение/загрузка в JSON формате
- Автоматическое удаление конфигурации при закрытии окна

**Методы:**
- `save_window_config()` - сохранение конфигурации
- `load_window_config()` - загрузка конфигурации
- `delete_window_config()` - удаление конфигурации

### 4. Исправление багов и оптимизация

#### Bug Fix 1: Позиционирование панели при resize окна
- Добавлен `resizeEvent()` в DraggablePlotWidget
- Автоматическое обновление позиции панели при изменении размера

#### Bug Fix 2: EventFilter для кликов на элементы панели
- Использование `self.rect().contains(click_pos)` для точной проверки
- Исключение кликов на кнопке настроек из обработки закрытия

#### Bug Fix 3: Логика кнопки настроек
- Метод `toggle_panel()` для корректного переключения видимости
- Закрытие панели при повторном клике на кнопку

#### Bug Fix 4: Смещение панели при открытии/закрытии
- Фиксированное позиционирование относительно графика
- Убрана зависимость от позиции кнопки настроек

#### Bug Fix 5: Корректное определение кликов внутри панели
- Проверка геометрии вместо иерархии объектов
- Использование `event.globalPos()` и `self.mapFromGlobal()`

#### Bug Fix 6: Ошибки сигналов PyQt5
- Изменение сигнала с `pyqtSignal(PlotSettings)` на `pyqtSignal()`
- Корректная обработка пользовательских типов в сигналах

## Архитектурные решения

### Принцип минималистичной архитектуры
- Создан только один новый файл для панели настроек
- Минимальные изменения существующих файлов
- Переиспользование существующей логики графиков

### Сигнальная система
- Использование сигналов PyQt5 для слабой связанности компонентов
- Асинхронное обновление настроек без блокировки UI

### Анимация и UX
- Плавная анимация для улучшения пользовательского опыта
- Интуитивное управление (клик вне панели = закрытие)
- Визуальная обратная связь через стилизацию

## Тестирование и отладка

### Выполненные тесты:
1. **Функциональное тестирование** - проверка всех настроек
2. **Интеграционное тестирование** - взаимодействие с графиками
3. **UI тестирование** - анимация, позиционирование, закрытие
4. **Обработка ошибок** - корректная работа при исключительных ситуациях

### Исправленные ошибки:
- TypeError в сигналах PyQt5
- Некорректное позиционирование панели
- Ложные срабатывания eventFilter
- Проблемы с анимацией при resize

## Результат

Упрощенная панель настроек графика полностью реализована и интегрирована в систему. Пользователи могут:
- Открывать панель настроек по кнопке в заголовке графика
- Настраивать временное окно отображения данных (1-1440 минут)
- Автоматически сохранять настройки окон

Все компоненты работают стабильно, интерфейс интуитивен, а код соответствует принципам минималистичной архитектуры проекта.

## Дополнительные правки и улучшения

### 1. Дальнейшее упрощение панели настроек (итерация упрощения)
**Дата:** 13.11.2025

**Изменения:**
- **Убраны чекбоксы автошкалы осей X и Y** - признаны избыточными для базовой функциональности
- **Убрана настройка максимального количества точек данных** - оставлена только настройка временного окна
- **Уменьшен размер панели** с 200x150 до 200x60 пикселей для более компактного вида
- **Упрощен класс PlotSettings** - оставлен только атрибут `time_window_minutes`

**Файлы изменены:**
- `vcas_viewer/plotting/plot_settings_panel.py` - убраны чекбоксы и spinbox, уменьшен размер
- `vcas_viewer/plotting/draggable_plot_widget.py` - убраны методы `set_auto_range()` и `set_max_points()`
- `vcas_viewer/plotting/plot_dock_window.py` - исправлена логика сохранения конфигурации

**Обоснование:** Следование принципу минималистичной архитектуры - создавать только необходимую функциональность.

### 2. Увеличение максимального количества окон графиков
**Дата:** 13.11.2025

**Изменения:**
- **Увеличен лимит окон с 5 до 30** для расширения возможностей работы с данными
- **Изменено значение** `self.max_windows = 30` в PlotManager

**Файлы изменены:**
- `vcas_viewer/plotting/plot_manager.py` - увеличен лимит максимального количества окон

**Обоснование:** Пользователи нуждаются в возможности одновременной работы с большим количеством графиков для комплексного анализа данных.

### 3. Исправление системы сериализации конфигурации окон
**Дата:** 13.11.2025

**Изменения:**
- **Исправлены методы сериализации** в WindowConfig для работы с упрощенным PlotSettings
- **Убраны поля auto_x, auto_y, max_data_points** из сериализации и десериализации
- **Исправлена логика сохранения настроек** в PlotDockWindow

**Файлы изменены:**
- `vcas_viewer/core/window_config.py` - упрощены методы to_dict() и from_dict()
- `vcas_viewer/plotting/plot_dock_window.py` - исправлена логика сохранения конфигурации

**Обоснование:** После упрощения PlotSettings необходимо было адаптировать систему сохранения конфигурации для совместимости с новыми структурами данных.

### 4. Исправление багов и ошибок
**Дата:** 13.11.2025

**Исправленные ошибки:**
- **TypeError в сигналах PyQt5** - сигнал settings_changed теперь без параметров
- **Ошибка в _update_time_range** - исправлена логика вычисления диапазона времени
- **AttributeError в сериализации** - убраны обращения к несуществующим атрибутам

**Файлы изменены:**
- `vcas_viewer/plotting/plot_settings_panel.py` - исправлен сигнал
- `vcas_viewer/plotting/draggable_plot_widget.py` - исправлена логика _update_time_range

**Результат исправлений:** Приложение запускается без ошибок, все компоненты работают стабильно.

## Итоговое состояние проекта

После всех правок и упрощений панель настроек графика стала максимально минималистичной, содержа только самую необходимую функциональность - настройку временного окна. Максимальное количество окон увеличено до 30, что позволяет пользователям эффективно работать с большим объемом данных. Система конфигурации окон полностью совместима с упрощенными настройками и работает без ошибок.

Все изменения проведены в соответствии с принципами минималистичной архитектуры и обеспечивают стабильную работу приложения.

## Последние изменения: Реализация управления окнами графиков

### Обзор задачи
**Дата:** 13.11.2025

**Задача:** Реализовать функционал переключения правой информационной панели на отдельное окно управления всеми окнами графиков, где будут отображены все окна с их настройками (окно выборки, выводимые каналы) и возможностью их закрытия или переименования.

### Архитектурные решения

#### Сигнальная система для обновления списка окон
- **Добавлен сигнал `settings_changed`** в `PlotDockWindow` для уведомления об изменениях настроек
- **Добавлен сигнал `plot_window_settings_changed`** в `PlotManager` для передачи изменений вверх по иерархии
- **Добавлен сигнал `settings_changed`** в `DraggablePlotWidget` для уведомления об изменениях настроек графика

#### Цепочка сигналов
```
DraggablePlotWidget.settings_changed
    ↓
PlotDockWindow._on_plot_settings_changed → PlotDockWindow.settings_changed
    ↓
PlotManager._on_plot_window_settings_changed → PlotManager.plot_window_settings_changed
    ↓
PlotWindowsManagerWidget._on_window_settings_changed → обновление списка
```

### Проблемы и решения

#### Проблема 1: Отсутствие обновления списка окон при изменении настроек
**Описание:** При изменении настроек графика (например, окна времени) список окон в панели управления не обновлялся автоматически.

**Решение:**
- Добавлена цепочка сигналов от `DraggablePlotWidget` через `PlotDockWindow` и `PlotManager` к `PlotWindowsManagerWidget`
- В `PlotWindowsManagerWidget._on_window_settings_changed()` вызывается `update_windows_list()` для обновления отображения

#### Проблема 2: Неправильное подключение сигналов в PlotDockWindow
**Описание:** Сигналы от графиков не подключались к обработчику в `PlotDockWindow`, так как подключение происходило только в `setup_connections()`, но новые графики добавлялись динамически.

**Решение:**
- Добавлено подключение сигналов в `setup_connections()` для существующих графиков
- Обработчик `_on_plot_settings_changed()` отправляет сигнал `settings_changed` от `PlotDockWindow`

#### Проблема 3: Отсутствие обработчика в PlotManager
**Описание:** `PlotManager` получал сигнал `settings_changed` от окон, но не имел метода для его обработки.

**Решение:**
- Добавлен метод `_on_plot_window_settings_changed()` в `PlotManager`
- Метод пересылает сигнал дальше через `plot_window_settings_changed.emit(plot_window)`

#### Проблема 4: Неправильное подключение сигналов в PlotWindowsManagerWidget
**Описание:** Сигнал `plot_window_settings_changed` от `PlotManager` не был подключен к обработчику в `PlotWindowsManagerWidget`.

**Решение:**
- Добавлено подключение сигнала в `setup_connections()`: `self.plot_manager.plot_window_settings_changed.connect(self._on_window_settings_changed)`
- Добавлен метод `_on_window_settings_changed()` для обновления списка окон

### Измененные файлы

#### vcas_viewer/plotting/draggable_plot_widget.py
- Добавлен сигнал `settings_changed = pyqtSignal()`
- В `_on_settings_changed()` добавлен вызов `self.settings_changed.emit()`

#### vcas_viewer/plotting/plot_dock_window.py
- Добавлен сигнал `settings_changed = pyqtSignal()` в класс
- В `setup_connections()` добавлено подключение сигналов от графиков
- Добавлен метод `_on_plot_settings_changed()` для обработки изменений настроек

#### vcas_viewer/plotting/plot_manager.py
- Добавлен сигнал `plot_window_settings_changed = pyqtSignal(object)` в класс
- В `_connect_plot_window_signals()` добавлено подключение `plot_window.settings_changed.connect(lambda: self._on_plot_window_settings_changed(plot_window))`
- Добавлен метод `_on_plot_window_settings_changed()` для пересылки сигнала

#### vcas_viewer/gui/widgets/plot_windows_manager_widget.py
- В `setup_connections()` добавлено подключение `self.plot_manager.plot_window_settings_changed.connect(self._on_window_settings_changed)`
- Добавлен метод `_on_window_settings_changed()` для обновления списка окон

### Тестирование

#### Выполненные проверки:
1. **Создание окон графиков** - корректное отображение в списке управления
2. **Изменение настроек графика** - автоматическое обновление информации в списке
3. **Переименование окон** - обновление названия в списке
4. **Закрытие окон** - удаление из списка управления
5. **Переключение режимов панели** - корректное переключение между информацией и управлением

#### Результаты тестирования:
- Все сигналы работают корректно
- Список окон обновляется в реальном времени
- Нет утечек памяти или циклических ссылок
- Интерфейс остается отзывчивым при обновлениях

### Заключение

Реализация управления окнами графиков завершена успешно. Добавлена сигнальная система для автоматического обновления списка окон при изменении их настроек. Все компоненты интегрированы без нарушения существующей архитектуры, в соответствии с принципами минималистичной разработки.

Пользователи теперь могут:
- Переключать правую панель в режим управления окнами графиков
- Видеть все открытые окна с их текущими настройками
- Переименовывать окна через диалог
- Закрывать окна с подтверждением
- Автоматически видеть обновления при изменении настроек графиков

## Следующая итерация: Многострочный интерфейс управления окнами графиков

### Обзор задачи
**Дата:** 14.11.2025

**Задача:** Переделать интерфейс управления окнами графиков из однострочного формата в многострочный виджет с тремя областями:
1. Название с inline-редактированием (Enter применяет, потеря фокуса откатывает)
2. Раскрывающийся список каналов с прокруткой
3. Функциональные кнопки (удаление, сохранение конфигурации, сохранение данных + скриншот)

### Архитектурные решения

#### Структура многострочного виджета
```
QVBoxLayout для каждого элемента окна:
├── QHBoxLayout (Строка названия):
│   ├── QLabel "Название:"
│   └── QLineEdit (inline-редактирование, Enter=применить, focusOut=откат)
├── QHBoxLayout (Строка каналов):
│   ├── QLabel "Каналы:"
│   └── QComboBox (раскрывающийся список с прокруткой)
└── QHBoxLayout (Строка кнопок):
    ├── QPushButton "Удалить окно"
    ├── QPushButton "Сохранить конфиг"
    ├── QPushButton "Сохранить данные"
    └── QPushButton "Скриншот графика"
```

#### Система сохранения данных
- **Директория:** `!data_exports/` в корне проекта
- **Формат данных:** CSV с временными рядами
- **Формат скриншотов:** PNG
- **Генерация имен:** `{дата}_{время}_{каналы1_каналы2_...}.csv/png`

### Новые функции

#### В PlotManager:
- `export_window_data(window_id: str, time_range: tuple = None) -> pd.DataFrame` - экспорт данных в DataFrame
- `export_window_config(window_id: str) -> dict` - экспорт конфигурации
- `save_window_data_csv(window_id: str, directory: str = "!data_exports") -> str` - сохранение CSV
- `save_window_screenshot(window_id: str, directory: str = "!data_exports") -> str` - скриншот окна

#### В PlotWindowsManagerWidget:
- `_create_window_item_widget(window_info: dict) -> QWidget` - создание многострочного виджета
- `_on_title_edit_finished(line_edit: QLineEdit, window_id: str)` - применение названия по Enter
- `_on_title_edit_focus_out(line_edit: QLineEdit, original_title: str)` - откат при потере фокуса
- `_save_window_config(window_id: str)` - сохранение конфигурации
- `_save_window_data(window_id: str)` - сохранение данных CSV
- `_save_window_screenshot(window_id: str)` - создание скриншота

### Технические особенности

#### Inline-редактирование названия:
- QLineEdit с сигналами `editingFinished` и `focusOut`
- `editingFinished` → применение изменений через PlotManager.rename_window()
- `focusOut` → откат к оригинальному значению

#### Раскрывающийся список каналов:
- QComboBox с `setMaxVisibleItems(10)` для прокрутки
- Автоматическое обновление при изменении каналов в окне
- Показ всех каналов, даже если их много

#### Система сохранения:
- Автоматическое создание директории `!data_exports`
- Генерация уникальных имен файлов по timestamp + каналам
- Подтверждение успешного сохранения через QMessageBox

### Проблемы и решения

1. **Inline-редактирование с откатом:**
   - Сохранять оригинальное значение при начале редактирования
   - При `focusOut` восстанавливать оригинал без применения
   - При `editingFinished` применять через PlotManager

2. **Производительность при большом списке каналов:**
   - Ограничить QComboBox до 100 элементов
   - Использовать виртуальную прокрутку если нужно

3. **Создание скриншотов графиков:**
   - Использовать `plot_widget.grab()` для захвата содержимого
   - Сохранять в PNG через QPixmap.save()

4. **Генерация имен файлов:**
   - Формат: `20251114_121500_channel1_channel2_channel3.csv`
   - Ограничить длину имени файла (макс 100 символов)

### Изменяемые файлы

- `vcas_viewer/plotting/plot_manager.py` - добавить методы экспорта и сохранения
- `vcas_viewer/gui/widgets/plot_windows_manager_widget.py` - переделать интерфейс на многострочный
- `DOCS/plans/implementation_plan.md` - добавить новый раздел плана

### Тестирование

Проверить:
- Inline-редактирование (Enter применяет, focusOut откатывает)
- Раскрывающийся список каналов с прокруткой
- Сохранение CSV данных в !data_exports
- Создание PNG скриншотов
- Корректность генерации имен файлов

### Порядок реализации

1. Добавить методы экспорта и сохранения в PlotManager
2. Переделать _add_window_item в PlotWindowsManagerWidget на многострочный виджет
3. Реализовать inline-редактирование названия
4. Добавить раскрывающийся список каналов
5. Реализовать кнопки сохранения и скриншотов
6. Протестировать функциональность
