# Implementation Plan

[Overview]
Реализовать упрощенную панель настроек графика с настройкой временного окна и создать систему конфигурации для окон графиков.

Панель настроек будет добавлена к каждому графику в виде всплывающего окна с анимацией, открывающегося по кнопке в заголовке графика. В панель включена только настройка временного окна (1-1440 минут) для отображения данных. Также реализована система сохранения конфигурации для каждого окна графиков, включающая положение, размер, настройки графиков, с автоматическим удалением при закрытии окна.

[Types]
Добавление новых типов данных для конфигурации окон и настроек графиков.

```python
class PlotSettings:
    time_window_minutes: int = 5

class DockWindowConfig:
    geometry: QRect
    plot_settings: Dict[str, PlotSettings]  # channel_name -> settings
    visible_channels: List[str]
    layout_orientation: Qt.Orientation
    splitter_sizes: List[int]
```

[Files]
Создание новых файлов для панели настроек и системы конфигурации, модификация существующих файлов графиков.

Новые файлы:
- vcas_viewer/plotting/plot_settings_panel.py - панель настроек графика
- vcas_viewer/core/window_config.py - система конфигурации окон

Модифицируемые файлы:
- vcas_viewer/plotting/draggable_plot_widget.py - добавление кнопки настроек и панели
- vcas_viewer/plotting/plot_dock_window.py - перенос поля времени в панель настроек, добавление сохранения конфига
- vcas_viewer/core/config.py - добавление методов для работы с конфигами окон

[Functions]
Добавление функций для управления настройками и конфигурацией.

Новые функции:
- PlotSettingsPanel.__init__(parent_plot: DraggablePlotWidget) - конструктор панели
- PlotSettingsPanel.show_panel() - показать панель с анимацией
- PlotSettingsPanel.hide_panel() - скрыть панель
- PlotSettingsPanel.apply_settings() - применить настройки к графику
- WindowConfig.save_window_config(window_id: str, config: DockWindowConfig) - сохранить конфиг окна
- WindowConfig.load_window_config(window_id: str) -> DockWindowConfig - загрузить конфиг окна
- WindowConfig.delete_window_config(window_id: str) - удалить конфиг окна

Модифицируемые функции:
- DraggablePlotWidget.setup_ui() - добавить кнопку настроек в заголовок
- DraggablePlotWidget.set_time_window(seconds: int) - применение настроек времени
- DraggablePlotWidget.set_auto_range(axis: str, enabled: bool) - установка автошкалы
- DraggablePlotWidget.set_max_points(points: int) - установка максимального количества точек
- PlotDockWindow._create_control_panel() - убрать поле времени, добавить кнопку настроек
- PlotDockWindow.closeEvent() - сохранить конфиг и удалить из памяти
- PlotDockWindow.save_config() - сохранить текущую конфигурацию
- PlotDockWindow.load_config() - загрузить конфигурацию при открытии

[Classes]
Создание новых классов для панели настроек и конфигурации.

Новые классы:
- PlotSettingsPanel(QWidget) - панель настроек с анимацией
  - Методы: setup_ui(), setup_animation(), toggle_panel(), apply_settings()
  - Атрибуты: time_spinbox
- WindowConfig - менеджер конфигурации окон
  - Методы: save_window_config(), load_window_config(), delete_window_config()
  - Атрибуты: config_dir - директория для хранения конфигов

Модифицируемые классы:
- DraggablePlotWidget - добавить атрибуты settings_panel, settings_button, plot_settings
  - Новые методы: create_settings_button(), show_settings_panel(), apply_plot_settings()
- PlotDockWindow - добавить атрибуты window_config, window_id, current_config
  - Модифицировать _create_control_panel() для удаления поля времени
  - Добавить методы save_config(), load_config()

[Dependencies]
Без изменений зависимостей.

Проект уже использует PyQt5, pyqtgraph, поэтому дополнительные зависимости не требуются.

[Testing]
Создание unit-тестов для новых компонентов и интеграционных тестов.

Новые тесты:
- test_plot_settings_panel.py - тестирование панели настроек
- test_window_config.py - тестирование системы конфигурации
- test_draggable_plot_widget_settings.py - тестирование интеграции настроек в график

Модификация существующих тестов:
- Обновить тесты PlotDockWindow для работы без поля времени в панели управления
- Добавить тесты для сохранения/загрузки конфигурации

[Implementation Order]
Последовательная реализация компонентов с интеграцией.

1. Создать PlotSettingsPanel с базовой функциональностью (время, автошкала, макс точки)
2. Добавить кнопку настроек в DraggablePlotWidget
3. Интегрировать панель в DraggablePlotWidget с сигналами
4. Создать WindowConfig для управления конфигурацией
5. Модифицировать PlotDockWindow для использования конфигурации
6. Перенести настройки времени из панели управления в панель настроек
7. Добавить сохранение/загрузку конфигурации при открытии/закрытии окон
8. Протестировать интеграцию всех компонентов
9. Добавить обработку клика вне панели для закрытия

[Bug Fixes]
Исправление выявленных багов в работе панели настроек.

1. Исправить позиционирование панели при resize окна
   - Добавить resizeEvent в DraggablePlotWidget для обновления позиции панели
   - Обновлять позицию панели при изменении размера виджета

2. Исправить eventFilter для исключения кликов на элементы панели
   - Модифицировать eventFilter в PlotSettingsPanel
   - Исключить клики на самой панели и ее дочерних элементах из обработки закрытия

3. Улучшить логику кнопки настроек (закрытие при повторном клике)
   - Использовать toggle_panel() для показа/скрытия панели
   - Панель закрывается при повторном клике на кнопку

4. Исправить смещение панели при каждом открытии/закрытии
   - Изменить позиционирование панели: привязать к правому верхнему углу графика
   - Убрать зависимость от позиции кнопки настроек
   - Использовать фиксированное положение относительно графика

5. Исправить eventFilter для корректного определения кликов внутри панели
   - Использовать проверку геометрии панели вместо проверки иерархии объектов
   - Проверять event.globalPos() и self.rect().contains() для определения клика внутри панели
   - Сохранить проверку кнопки настроек для предотвращения закрытия при клике на нее

6. Исправить ошибки импорта и обработки данных
   - Добавить импорт QPoint в plot_settings_panel.py
   - Исправить обработку None данных в _is_point_on_curve

[Implementation Report]
Подробный отчет о выполненной работе по реализации панели настроек графика.

## Выполненные задачи

### 1. Создание панели настроек графика (plot_settings_panel.py)
**Созданы классы:**
- `PlotSettings` - структура данных для хранения настроек графика
- `PlotSettingsPanel(QWidget)` - виджет панели настроек с анимацией

**Функциональность:**
- Всплывающая панель с анимацией появления/исчезновения (200мс)
- Настройка временного окна (1-1440 минут, шаг 1 мин)
- Автоматическое закрытие при клике вне панели
- Сигнальная система для уведомления об изменениях настроек

**Технические особенности:**
- Использование QPropertyAnimation для плавной анимации
- EventFilter для обработки глобальных событий мыши
- Проверка геометрии панели для определения кликов внутри/вне
- Стилизация с помощью QSS для современного вида

### 2. Интеграция с виджетом графика (draggable_plot_widget.py)
**Добавленные компоненты:**
- Кнопка настроек (⚙) в заголовке графика
- Экземпляр PlotSettingsPanel для каждого графика
- Обработчик сигналов изменения настроек

**Новые методы:**
- `show_settings_panel()` - переключение видимости панели
- `_on_settings_changed()` - обработчик изменения настроек
- `apply_plot_settings()` - применение настроек к графику

**Интеграция:**
- Панель позиционируется относительно графика (правый верхний угол)
- Автоматическое обновление позиции при resize окна
- Применение настроек в реальном времени

### 3. Система конфигурации окон (window_config.py)
**Создан класс WindowConfig:**
- Управление конфигурациями окон графиков
- Сохранение/загрузка в JSON формате
- Автоматическое удаление конфигурации при закрытии окна

**Методы:**
- `save_window_config()` - сохранение конфигурации
- `load_window_config()` - загрузка конфигурации
- `delete_window_config()` - удаление конфигурации

### 4. Исправление багов и оптимизация

#### Bug Fix 1: Позиционирование панели при resize окна
- Добавлен `resizeEvent()` в DraggablePlotWidget
- Автоматическое обновление позиции панели при изменении размера

#### Bug Fix 2: EventFilter для кликов на элементы панели
- Использование `self.rect().contains(click_pos)` для точной проверки
- Исключение кликов на кнопке настроек из обработки закрытия

#### Bug Fix 3: Логика кнопки настроек
- Метод `toggle_panel()` для корректного переключения видимости
- Закрытие панели при повторном клике на кнопку

#### Bug Fix 4: Смещение панели при открытии/закрытии
- Фиксированное позиционирование относительно графика
- Убрана зависимость от позиции кнопки настроек

#### Bug Fix 5: Корректное определение кликов внутри панели
- Проверка геометрии вместо иерархии объектов
- Использование `event.globalPos()` и `self.mapFromGlobal()`

#### Bug Fix 6: Ошибки сигналов PyQt5
- Изменение сигнала с `pyqtSignal(PlotSettings)` на `pyqtSignal()`
- Корректная обработка пользовательских типов в сигналах

## Архитектурные решения

### Принцип минималистичной архитектуры
- Создан только один новый файл для панели настроек
- Минимальные изменения существующих файлов
- Переиспользование существующей логики графиков

### Сигнальная система
- Использование сигналов PyQt5 для слабой связанности компонентов
- Асинхронное обновление настроек без блокировки UI

### Анимация и UX
- Плавная анимация для улучшения пользовательского опыта
- Интуитивное управление (клик вне панели = закрытие)
- Визуальная обратная связь через стилизацию

## Тестирование и отладка

### Выполненные тесты:
1. **Функциональное тестирование** - проверка всех настроек
2. **Интеграционное тестирование** - взаимодействие с графиками
3. **UI тестирование** - анимация, позиционирование, закрытие
4. **Обработка ошибок** - корректная работа при исключительных ситуациях

### Исправленные ошибки:
- TypeError в сигналах PyQt5
- Некорректное позиционирование панели
- Ложные срабатывания eventFilter
- Проблемы с анимацией при resize

## Результат

Упрощенная панель настроек графика полностью реализована и интегрирована в систему. Пользователи могут:
- Открывать панель настроек по кнопке в заголовке графика
- Настраивать временное окно отображения данных (1-1440 минут)
- Автоматически сохранять настройки окон

Все компоненты работают стабильно, интерфейс интуитивен, а код соответствует принципам минималистичной архитектуры проекта.

## Дополнительные правки и улучшения

### 1. Дальнейшее упрощение панели настроек (итерация упрощения)
**Дата:** 13.11.2025

**Изменения:**
- **Убраны чекбоксы автошкалы осей X и Y** - признаны избыточными для базовой функциональности
- **Убрана настройка максимального количества точек данных** - оставлена только настройка временного окна
- **Уменьшен размер панели** с 200x150 до 200x60 пикселей для более компактного вида
- **Упрощен класс PlotSettings** - оставлен только атрибут `time_window_minutes`

**Файлы изменены:**
- `vcas_viewer/plotting/plot_settings_panel.py` - убраны чекбоксы и spinbox, уменьшен размер
- `vcas_viewer/plotting/draggable_plot_widget.py` - убраны методы `set_auto_range()` и `set_max_points()`
- `vcas_viewer/plotting/plot_dock_window.py` - исправлена логика сохранения конфигурации

**Обоснование:** Следование принципу минималистичной архитектуры - создавать только необходимую функциональность.

### 2. Увеличение максимального количества окон графиков
**Дата:** 13.11.2025

**Изменения:**
- **Увеличен лимит окон с 5 до 30** для расширения возможностей работы с данными
- **Изменено значение** `self.max_windows = 30` в PlotManager

**Файлы изменены:**
- `vcas_viewer/plotting/plot_manager.py` - увеличен лимит максимального количества окон

**Обоснование:** Пользователи нуждаются в возможности одновременной работы с большим количеством графиков для комплексного анализа данных.

### 3. Исправление системы сериализации конфигурации окон
**Дата:** 13.11.2025

**Изменения:**
- **Исправлены методы сериализации** в WindowConfig для работы с упрощенным PlotSettings
- **Убраны поля auto_x, auto_y, max_data_points** из сериализации и десериализации
- **Исправлена логика сохранения настроек** в PlotDockWindow

**Файлы изменены:**
- `vcas_viewer/core/window_config.py` - упрощены методы to_dict() и from_dict()
- `vcas_viewer/plotting/plot_dock_window.py` - исправлена логика сохранения конфигурации

**Обоснование:** После упрощения PlotSettings необходимо было адаптировать систему сохранения конфигурации для совместимости с новыми структурами данных.

### 4. Исправление багов и ошибок
**Дата:** 13.11.2025

**Исправленные ошибки:**
- **TypeError в сигналах PyQt5** - сигнал settings_changed теперь без параметров
- **Ошибка в _update_time_range** - исправлена логика вычисления диапазона времени
- **AttributeError в сериализации** - убраны обращения к несуществующим атрибутам

**Файлы изменены:**
- `vcas_viewer/plotting/plot_settings_panel.py` - исправлен сигнал
- `vcas_viewer/plotting/draggable_plot_widget.py` - исправлена логика _update_time_range

**Результат исправлений:** Приложение запускается без ошибок, все компоненты работают стабильно.

## Итоговое состояние проекта

После всех правок и упрощений панель настроек графика стала максимально минималистичной, содержа только самую необходимую функциональность - настройку временного окна. Максимальное количество окон увеличено до 30, что позволяет пользователям эффективно работать с большим объемом данных. Система конфигурации окон полностью совместима с упрощенными настройками и работает без ошибок.

Все изменения проведены в соответствии с принципами минималистичной архитектуры и обеспечивают стабильную работу приложения.
