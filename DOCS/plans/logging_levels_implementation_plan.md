# План реализации уровней логирования для консольного вывода

## Исходная проблема

В текущей версии VCAS Viewer наблюдается проблема избыточного логирования в консоли:

- При запуске программы в терминале выводится большое количество информационных сообщений с уровнем INFO
- Частые повторяющиеся конструкции в логах озадают громоздкий вывод
- Отсутствует возможность настройки уровня детализации терминального логирования
- По умолчанию используется INFO уровень, что слишком подробно для повседневного использования
- Нет простого способа переключения между "тихим" и "отладочным" режимами работы

Проблема проявляется в следующих ситуациях:
- Подключение к серверу - множественные сообщения о каждом шаге
- Обработка каналов данных - повторяющиеся уведомления
- Инициализация компонентов - детальные сообщения о каждом виджете

**Требуемое решение:** Три режима логирования с возможностью выбора через командную строку

## Анализ текущего состояния логирования

### Архитектура существующего логирования

1. **Централизованная настройка**: Логирование инициализируется в `MainWindow.setup_logging()` с фиксированными параметрами
2. **Вывод форматирован по времени**: `'%(asctime)s - %(name)s - %(levelname)s - %(message)s'`
3. **Двойной вывод**: одновременный вывод в консоль (`StreamHandler`) и файл (`vcas_viewer.log`)
4. **Используемые уровни**:
   - `INFO`: для информационных сообщений о работе программы
   - `DEBUG`: для детальной отладки (множественные сообщения)
   - `WARNING`: для предупреждений
   - `ERROR`: для ошибок
   - `CRITICAL`: для критических ошибок

### Основные источники логирования

- **VCASClient** (`vcas_viewer/core/vcas_client.py`): взаимодействие с сервером, получение данных, обработка сообщений
- **MainWindow** (`vcas_viewer/gui/main_window.py`): инициализация, управление окнами, пользовательские действия
- **PlotManager** (`vcas_viewer/plotting/plot_manager.py`): управление графиками и окнами графиков
- **ChannelTreeWidget** (`vcas_viewer/gui/widgets/channel_tree_widget.py`): работа с деревом каналов
- **MockVCASServer** (`vcas_viewer/core/mock_vcas_server.py`): логирование работы тестового сервера (каждый канал генерирует много сообщений)

### Текущие недостатки

1. **Отсутствие управления**: Нет способа изменения уровня логирования через интерфейс
2. **Фиксированный INFO уровень**: По умолчанию всегда выводится слишком много информации
3. **Отсутствие --debug совместимости**: В mock сервере есть аргумент `--debug`, но он работает только для сервера
4. **Повторяющиеся конструкции**: Многие циклы генерируют одинаковые сообщения повторно

## Дизайн решения

### Определение трех уровней логирования

1. **minimal** (по умолчанию):
   - Уровень: WARNING и выше
   - Содержание: Только отчеты о запуске/остановке программы, критические ошибки, фундаментальные проблемы
   - Цель: Максимально тихая работа для оператора в режиме реального использования

2. **concise**:
   - Уровень: INFO и выше
   - Содержание: Основные информационные сообщения без чрезмерной детализации
   - Цель: Баланс между информативностью и читаемостью - показывать важные операции, но избегать шума

3. **full**:
   - Уровень: DEBUG и выше
   - Содержание: Полная отладочная информация для разработки
   - Цель: Подробная диагностика кода, изменение значений, каждый запрос к серверу и т.д.

### Автоматическое определение уровня

- **По умолчанию**: `minimal` (тихий режим для повседневного использования)
- **Принудительное включение**: `--logging minimal|concise|full` или `--log-level minimal|concise|full`
- **Совместимость**: Сохранение `--debug` как синоним `full` для mock сервера

### Архитектурные принципы

1. **Централизация**: Создание единого модуля `logging_config.py` для управления уровнями
2. **Раннее применение**: Настройка уровня логирования на этапе инициализации, до создания основных компонентов
3. **Обратная совместимость**: Сохранение существующих вызовов логирования без изменений
4. **Всеобъемлющая настройка**: Установка уровня для root логера, затрагивающего все компоненты

## План реализации

### Этап 1: Создание модуля централизованного управления логированием

Создать файл `vcas_viewer/core/logging_config.py` с функциями:

```python
def parse_logging_level(args):
    """Парсит аргументы командной строки для уровня логирования"""

def configure_logging(level):
    """Настраивает глобальное логирование с указанным уровнем"""

def get_logging_level_from_string(level_str):
    """Преобразует строку в уровень логирования"""
```

**Задачи:**
- Импорт `logging`
- Создание соответствий уровней: minimal->WARNING, concise->INFO, full->DEBUG
- Валидация входных значений
- Настройка формата сообщений (время, модуль, уровень, сообщение)

### Этап 2: Модификация точки входа верхнего уровня (main.py)

**Изменяемая функциональность:**
```python
def setup_application():
    # Добавить парсинг аргументов перед созданием QApplication
    logging_level = parse_logging_level(sys.argv)
    configure_logging(logging_level)
```

**Мотивация:** Это корневая точка входа, которая делегатает выполнение vcas_viewer.main

### Этап 3: Модификация основной точки входа (vcas_viewer/main.py)

Аналогично этапу 2 - добавить парсинг аргументов для возможного раздельного запуска через `python -m vcas_viewer`

### Этап 4: Упрощение MainWindow.setup_logging()

**Текущий код:**
```python
def setup_logging(self):
    logging.basicConfig(
        level=logging.INFO,  # Фиксированное значение
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        handlers=[logging.StreamHandler(), logging.FileHandler('vcas_viewer.log', encoding='utf-8')]
    )
```

**Новый код:**
```python
def setup_logging(self):
    # Логирование уже настроено глобально, но можно добавить специфические handlers
    pass  # или добавить дополнительные настройки если необходимо
```

**Мотивация:** Уровень установлен ранее, основная настройка уже выполнена

### Этап 5: Обновление Mock сервера для совместимости

**Изменения в `vcas_viewer/core/mock_vcas_server.py`:**
- Сохранить аргумент `--debug` как обратную совместимость
- Фактически использовать новый механизм установки уровня

**Обновленная функция main():**
```python
if args.debug:
    logging.getLogger().setLevel(logging.DEBUG)
# Но лучше интегрировать с новой системой
```

### Этап 6: Адаптация существующих вызовов логирования

**Анализ необходимости изменений:**
- В минимальном режиме INFO сообщения будут скрыты - требует проверки
- Возможно потребуется повышение уровня некоторых важных INFO сообщений до WARNING
- Или понижение слишком детальных DEBUG сообщений

**Примеры возможных изменений:**
- Начальные информационные сообщения ("Подключено к серверу") оставить INFO
- Детальные циклические сообщения ("Получено обновление канала X") перевести в DEBUG
- Сообщения об ошибках уже имеют соответствующие уровни (ERROR, CRITICAL)

## Файлы для изменения

### Обязательные изменения

1. `main.py` - modification required for command line argument parsing
2. `vcas_viewer/main.py` - modification for main application entry point
3. `vcas_viewer/gui/main_window.py` - simplify setup_logging method
4. `vcas_viewer/core/logging_config.py` - created new module
5. `vcas_viewer/core/mock_vcas_server.py` - update for compatibility

### Опциональные хотфиксы

6. `vcas_viewer/core/vcas_client.py` - possible level adjustments for repetitive messages
7. `vcas_viewer/models/channel_data.py` - review logging verbosity

## Тестирование и верификация

### Регрессионное тестирование

1. **Тестирование запуска в разных режимах:**
   ```bash
   # По умолчанию (minimal)
   python main.py

   # Concise режим
   python main.py --logging concise

   # Full режим
   python main.py --logging full

   # Совместимость с mock
   python main.py --mock-server --logging full
   ```

2. **Проверка консольного вывода:**
   - minimal: только старт/стоп, критические ошибки
   - concise: основные операции (подключение, получение каналов)
   - full: детальная последовательность (каждый запрос, каждое значение)

3. **Функциональная верификация:**
   - Подключение к реальному серверу ВЭПП-2000
   - Создание окон графиков с каналами
   - Просмотр деревьев каналов
   - Работа с несколькими окнами

### Отчет о результатах

После реализации каждого этапа:
- Создать отчет о рядах команд для каждого уровня
- Типичное количество строк вывода в консоли
- Примеры сообщений для каждого уровня

## Риски и меры предосторожности

1. **Изменение поведения по умолчанию:** После изменений по умолчанию будет минимальный вывод. Есть риск упустить важную информацию для пользователей.

2. **Новое требование к командной строке:** Для детального логирования потребуется явно указывать флаги.

3. **Совместимость с существующими установками:** Проверить, что старые способы запуска (без флагов) работают корректно.

## Метрики успеха

- Minimal режим: максимум 5-10 строк вывода на сессию кроме ошибок
- Concise режим: 20-50 строк с информацией о основных операциях
- Full режим: 100+ строк с полной детализацией
- Сохранение возможности отладки через --logging full или --debug

## Временная оценка

- Этап 1: 1-2 часа (создание модуля)
- Этап 2-5: 2-3 часа (модификация существующих файлов)
- Этап 6: 1-2 часа (Харджирование и валидация уровней сообщений)
- Тестирование: 2-3 часа (проверка всех режимов и сценариев)

**Общее время:** 6-10 часов разработки + тестирование в различных условиях.

## Примеры использования после внедрения

```bash
# Тихий режим (для операторов)
python main.py

# Стандартный режим (для анализа проблем)
python main.py --logging concise

# Отладочный режим (для разработчиков)
python main.py --logging full

# Отладка с тестовым сервером
python main.py --mock --logging full
```

Реализация этой системы позволит гибко управлять уровнем логирования в зависимости от потребностей пользованияю, значительно улучшая пользовательский опыт в различных сценариях использования программы.

## Отчет о выполнении

### Выполненные задачи
- [x] Создан модуль `vcas_viewer/core/logging_config.py` с централизованным управлением уровнями
- [x] Добавлена поддержка аргументов `--logging minimal|concise|full` в точки входа
- [x] Модифицированы точки входа `main.py` и `vcas_viewer/main.py` для раннего применения настройки
- [x] Упрощен метод `MainWindow.setup_logging()` для исключения дублирования конфигурации
- [x] Обновлен MockVCASServer для совместимости с новой системой логирования
- [x] Проведено предварительное тестирование базовой функциональности

### Ключевые технические решения
- Использован `logging.basicConfig(force=True)` для перезаписи предыдущих настроек
- Реализован ранний парсинг аргументов командной строки до инициализации QApplication
- Установлен `minimal` режим (WARNING+) как по умолчанию для тихой работы
- Сохранена обратная совместимость с аргументом `--debug` в mock сервере
- Применена централизованная настройка уровня root логера для всех модулей

### Предположения и допущения
- Существующие вызовы логирования корректно используют уровни INFO/WARNING/ERROR/DEBUG
- Для minimal режима достаточно уровня WARNING без необходимости изменения существующих логиков
- Mock сервер запускается независимо с собственными настройками логирования

### Потенциальные проблемы и ограничения
- При слабом сигнале или сетевых проблемах количество WARNING/CONNECT сообщений может быть значительным
- Наблюдается проблема кодировки в выводе (CP1251 vs UTF-8) - требуется дополнительное исследование
- В `minimal` режиме отсутствует информация о успешном подключении к серверу

### Рекомендации по доработке
- Добавить опциональные аргументы `--quiet` как алиас `minimal` и `--verbose` как алиас `full`
- Провести полный цикл тестирования в разных сетевых условиях
- Изучить и исправить вопросы кодировки русских символов в логах
- Рассмотреть добавление INFO-сообщений о критических событиях (подключение/отключение) в minimal режиме
