= ChannelData

// Метаданные для машинной читаемости
:component: ChannelData
:tags: [компонент, channeldata, данные, модель, временные_ряды]
:dependencies: [numpy, typing]
:related: [components/PlotManager.adoc, components/VCASClient.adoc]

== Назначение

ChannelData - класс для хранения и управления временными рядами данных каналов VCAS. Предоставляет интерфейс для добавления точек данных, управления метаданными, сериализации/десериализации и отображения данных в графиках.

== Основные функции

* Хранение временных рядов данных (timestamp, value)
* Управление метаданными канала (тип, единицы, описание)
* Кэширование и ограничение количества точек данных
* Вычисление диапазонов значений и времени
* Управление настройками отображения
* Сериализация для сохранения/загрузки данных

== Структура класса

=== Атрибуты
* **name**: Имя канала (строка)
* **description**: Описание канала
* **units**: Единицы измерения
* **use_system_time**: Флаг использования системного времени вместо серверного
* **data**: Список кортежей (timestamp, value)
* **metadata**: Словарь метаданных (type, min_value, max_value, etc.)
* **display_settings**: Настройки отображения (color, visible, line_width, etc.)
* **logger**: Логгер для записи событий

=== Основные методы

==== Управление данными
* **add_data_point(timestamp, value, use_system_time)**: Добавление одной точки данных
* **add_data_points(timestamps, values, use_system_time)**: Добавление нескольких точек
* **clear_data()**: Очистка всех данных
* **limit_data_points(max_points)**: Ограничение количества точек

==== Доступ к данным
* **get_data_arrays()**: Получение массивов numpy для графиков (timestamps, values)
* **get_latest_value()**: Последнее значение
* **get_latest_timestamp()**: Временная метка последнего значения
* **get_time_range()**: Диапазон времени данных (min, max)
* **get_value_range()**: Диапазон значений данных (min, max)

==== Метаданные и настройки
* **set_display_color(color)**: Цвет отображения
* **set_visibility(visible)**: Видимость канала
* **update_metadata(info_dict)**: Обновление метаданных

==== Сериализация
* **to_dict()**: Преобразование в словарь для сериализации
* **from_dict(data)**: Создание объекта из словаря

== Особенности работы

=== Использование времени
* Два режима: системное время (машины) и серверное время (из VCAS)
* Системное время используется для графиков в реальном времени
* Серверное время сохраняется для исторических данных
* Флаг use_system_time контролирует поведение при добавлении точек

=== Типы данных каналов VCAS
* **ro** (read-only): каналы только для чтения
* **rw** (read-write): каналы для чтения и записи
* **ex** (exclusive): эксклюзивные каналы

=== Кэширование и производительность
* Ограничение количества точек для предотвращения утечки памяти
* Быстрый доступ к min/max значениям через кэшированные метаданные
* Numpy массивы для эффективной работы с графиками

== Примеры использования

[source,python]
----
// Создание объекта данных канала
channel_data = ChannelData("VEPP/Energy", "Энергия пучка", "MeV")

// Добавление точек данных
channel_data.add_data_point(time.time(), 200.5)
channel_data.add_data_points([t1, t2], [v1, v2])

// Получение данных для графиков
timestamps, values = channel_data.get_data_arrays()

// Сериализация
data_dict = channel_data.to_dict()
channel_data_copy = ChannelData.from_dict(data_dict)
----

== Взаимодействия

* **С PlotManager**: Используется для хранения данных всех каналов, обновление графиков
* **С VCASClient**: Получает данные через сигналы об обновлениях
* **С PlotDockWindow**: Предоставляет массивы данных для PyQtChart

== Модель данных

[source,json]
----
{
  "name": "VEPP/Energy",
  "description": "Energy of the beam",
  "units": "MeV",
  "data": [
    [1640995200.0, 500.0],
    [1640995201.0, 499.5]
  ],
  "metadata": {
    "type": "ro",
    "min_value": 495.0,
    "max_value": 505.0,
    "data_points": 2
  },
  "display_settings": {
    "color": "#FF0000",
    "visible": true,
    "line_width": 2
  }
}
----

== Зависимости

* **numpy**: Для создания массивов данных
* **typing**: Для типизации
* **time**: Для работы с временными метками
* **logging**: Для записи событий

Связанные компоненты:

* xref:components/PlotManager.adoc[PlotManager] - менеджер графиков
* xref:components/VCASClient.adoc[VCASClient] - источник данных
* xref:api/interfaces.adoc[VCAS Протокол] - формат данных
